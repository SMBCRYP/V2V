<script>
    const scanBtn = document.getElementById('scan-btn');
    const resultsContainer = document.getElementById('results-container');
    const statusEl = document.getElementById('status');
    let allConfigs = [];
    
    // --- آدرس پروکسی شما با موفقیت جای‌گذاری شد ---
    const PROXY_URL = "wss://rapid-scene-1da6.mbrgh87.workers.dev/"; 
    
    function getUseCase(ping) {
        if (ping < 250) return '🎮 عالی برای: گیم و وب‌گردی';
        if (ping < 500) return '🎬 مناسب برای: استریم و شبکه‌های اجتماعی';
        return '📁 مناسب برای: دانلود';
    }

    function pingOnce(config) {
        return new Promise(resolve => {
            const startTime = Date.now();
            const timeoutDuration = 3000;
            let ws;
            try {
                // آدرس ورکر شما برای پینگ استفاده می‌شود
                ws = new WebSocket(PROXY_URL);
                ws.onopen = () => ws.send(JSON.stringify({ address: config.address, port: config.port }));
                ws.onmessage = (event) => { if (event.data === "success") succeed(); };
            } catch (e) { fail(); return; }
            const timeout = setTimeout(fail, timeoutDuration);
            function succeed() { clearTimeout(timeout); ws.close(); resolve(Date.now() - startTime); }
            function fail() { clearTimeout(timeout); if (ws) ws.close(); resolve(null); }
            ws.onerror = fail;
        });
    }

    function createConfigCard(config) {
        const card = document.createElement('div');
        card.className = 'card';
        const pingClass = config.ping < 400 ? 'fast' : (config.ping < 800 ? 'medium' : 'slow');
        card.style.borderColor = `var(--${pingClass})`;
        const useCaseText = getUseCase(config.ping);
        card.innerHTML = `<div class="card-header"><div class="card-location"><span class="fi fi-${config.country_code || 'xx'}"></span><span style="margin-right:10px;">${config.country || 'Unknown'}</span></div><div class="ping ${pingClass}">${config.ping}ms</div></div><div class="card-details"><strong>${config.remarks}</strong></div><div class="use-case">${useCaseText}</div><div class="card-footer"><button onclick="copyConfig('${config.config_str}')">کپی</button></div>`;
        return card;
    }
    
    function copyConfig(configStr) { navigator.clipboard.writeText(configStr); alert('کپی شد!'); }

    function renderList(configs) {
        resultsContainer.innerHTML = '';
        if (configs.length === 0) { statusEl.textContent = 'هیچ کانفیگ آنلاینی یافت نشد.'; return; }
        configs.forEach(config => resultsContainer.appendChild(createConfigCard(config)));
        statusEl.textContent = `نمایش ${configs.length} کانفیگ آنلاین`;
    }
    
    async function runFullScan() {
        if (!allConfigs.length) { statusEl.textContent = 'هیچ کانفیگی برای تست یافت نشد.'; return; }
        if (!PROXY_URL.includes("workers.dev")) { statusEl.textContent = 'خطا: لطفاً آدرس پراکسی شخصی خود را در کد index.html وارد کنید.'; return; }

        const btnUI = scanBtn.querySelector('span');
        const spinner = scanBtn.querySelector('.spinner');
        scanBtn.disabled = true;
        btnUI.textContent = 'در حال تست...';
        spinner.style.display = 'inline-block';
        resultsContainer.innerHTML = '';

        const testPromises = allConfigs.map(config => pingOnce(config));
        const results = await Promise.all(testPromises);
        
        const onlineConfigs = allConfigs
            .map((config, i) => ({ ...config, ping: results[i] }))
            .filter(r => r.ping !== null)
            .sort((a, b) => a.ping - b.ping);

        renderList(onlineConfigs);

        scanBtn.disabled = false;
        btnUI.textContent = '🔄 تست مجدد';
        spinner.style.display = 'none';
    }

    async function init() {
        try {
            const response = await fetch('configs.json?v=' + Date.now());
            if (!response.ok) throw new Error('Network error');
            allConfigs = await response.json();
            if(!Array.isArray(allConfigs)) throw new Error("Data is not an array");
            statusEl.textContent = `مجموع ${allConfigs.length} کانفیگ یافت شد. شروع تست...`;
            runFullScan();
        } catch (error) {
            statusEl.textContent = 'خطا در بارگذاری اولیه. لطفاً صفحه را رفرش کنید.';
        }
    }
    scanBtn.addEventListener('click', runFullScan);
    init();
</script>
