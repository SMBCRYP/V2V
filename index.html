<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V2V Configs v5</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1c1c1c">
    <style>
        :root {
            --bg-color: #121212; --primary-color: #1e1e1e; --secondary-color: #2a2a2a;
            --text-color: #e0e0e0; --subtle-text-color: #888; --accent-color: #009688;
        }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 1rem;
        }
        .container { max-width: 800px; margin: 0 auto; }
        .header { text-align: center; border-bottom: 1px solid var(--secondary-color); padding-bottom: 1rem; margin-bottom: 1.5rem; }
        .header h1 { color: var(--accent-color); margin: 0; }
        .main-btn {
            background-color: var(--accent-color); color: white; border: none; padding: 15px 20px; font-size: 1.1rem;
            font-weight: bold; border-radius: 8px; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem;
        }
        .main-btn .spinner { display: none; border: 3px solid #fff; border-top-color: transparent; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin-left: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .card {
            background-color: var(--primary-color); border-radius: 8px; padding: 15px; margin-bottom: 1rem;
            border-left: 4px solid var(--secondary-color); transition: border-color 0.3s;
        }
        .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .card-location { display: flex; align-items: center; font-weight: bold; }
        .card-location .fi { font-size: 1.5rem; margin-left: 10px; border-radius: 3px; }
        .ping { font-size: 0.9rem; font-weight: bold; color: var(--subtle-text-color); }
        .ping.fast { color: #4caf50; } .ping.medium { color: #ff9800; } .ping.slow { color: #f44336; }
        .card-details { font-size: 0.85rem; color: var(--subtle-text-color); line-height: 1.6; }
        .use-case { font-size: 0.8rem; font-weight: bold; margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--secondary-color); }
        .card-footer { margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px; }
        .card-footer button {
            background-color: var(--secondary-color); color: var(--text-color); border: none; padding: 8px 15px;
            border-radius: 5px; cursor: pointer; font-family: inherit; font-size: 0.9rem;
        }
        h2 { text-align: center; color: var(--subtle-text-color); border-bottom: 1px solid var(--secondary-color); padding-bottom: 10px; }
        #qr-modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center; }
        #qr-code-container { background-color: white; padding: 20px; border-radius: 8px; }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@6.6.6/css/flag-icons.min.css"/>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>V2V Configs v5</h1>
            <p id="status">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§...</p>
        </div>
        
        <button id="scan-btn" class="main-btn">
            <span>ğŸš€ ØªØ³Øª Ùˆ ÛŒØ§ÙØªÙ† Ø¨Ù‡ØªØ±ÛŒÙ† Ú©Ø§Ù†ÙÛŒÚ¯</span>
            <div class="spinner"></div>
        </button>
        
        <div id="results-container"></div>
        
        <div id="full-list-section">
            <h2>Ù„ÛŒØ³Øª Ú©Ø§Ù…Ù„ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§</h2>
            <div id="full-list-container"></div>
        </div>
    </div>

    <div id="qr-modal"><div id="qr-code-container"></div></div>

    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => navigator.serviceWorker.register('/V2V/sw.js'));
        }

        const scanBtn = document.getElementById('scan-btn');
        const resultsContainer = document.getElementById('results-container');
        const fullListContainer = document.getElementById('full-list-container');
        const statusEl = document.getElementById('status');
        const qrModal = document.getElementById('qr-modal');
        const qrCodeContainer = document.getElementById('qr-code-container');

        let allConfigs = [];
        
        function getUseCase(ping) {
            if (typeof ping !== 'number') return 'â” Ú©Ø§Ø±Ø¨Ø±Ø¯: Ù†Ø§Ù…Ø´Ø®Øµ (Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªØ³Øª)';
            if (ping < 250) return 'ğŸ® Ø¹Ø§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ: Ú¯ÛŒÙ…ØŒ ØªØ±ÛŒØ¯ Ùˆ ÙˆØ¨â€ŒÚ¯Ø±Ø¯ÛŒ Ø³Ø±ÛŒØ¹';
            if (ping < 500) return 'ğŸ¬ Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø±Ø§ÛŒ: Ø§Ø³ØªØ±ÛŒÙ…ØŒ ÙˆÛŒØ¯ÛŒÙˆ Ùˆ Ø´Ø¨Ú©Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ';
            return 'ğŸ“ Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø±Ø§ÛŒ: Ø¯Ø§Ù†Ù„ÙˆØ¯ Ùˆ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ';
        }

        function pingOnce(config, useProxy = false) {
            return new Promise(resolve => {
                const startTime = Date.now();
                const timeoutDuration = 2500;
                let ws;
                try {
                    if (useProxy) {
                        ws = new WebSocket("wss://proxy.yebekhe.link");
                        ws.onopen = () => ws.send(`CONNECT ${config.address}:${config.port} HTTP/1.1\r\nHost: ${config.address}\r\n\r\n`);
                        ws.onmessage = (event) => { if (event.data.includes("HTTP/1.1 200")) succeed(); };
                    } else {
                        ws = new WebSocket(`wss://${config.address}:${config.port}`);
                        ws.onopen = succeed;
                    }
                } catch (e) { fail('Error'); return; }

                const timeout = setTimeout(() => fail('Timeout'), timeoutDuration);

                function succeed() {
                    const latency = Date.now() - startTime;
                    clearTimeout(timeout);
                    ws.close();
                    resolve(latency);
                }
                function fail(errorType) {
                    clearTimeout(timeout);
                    if (ws) ws.close();
                    if (!useProxy) { resolve(pingOnce(config, true)); } 
                    else { resolve(errorType); }
                }
                ws.onerror = () => fail('Error');
            });
        }

        async function getAverageLatency(config, pings = 3) {
            const results = [];
            for (let i = 0; i < pings; i++) { results.push(await pingOnce(config)); }
            const successfulPings = results.filter(r => typeof r === 'number');
            if (successfulPings.length === 0) { return { ...config, ping: 'Error' }; }
            const average = successfulPings.reduce((a, b) => a + b, 0) / successfulPings.length;
            return { ...config, ping: Math.round(average) };
        }

        function createConfigCard(config) {
            try {
                const card = document.createElement('div');
                card.className = 'card';
                let pingClass = '', pingText = 'ØªØ³Øª Ù†Ø´Ø¯Ù‡';
                if (typeof config.ping === 'number') {
                    pingText = `${config.ping}ms`;
                    if (config.ping < 400) pingClass = 'fast';
                    else if (config.ping < 800) pingClass = 'medium';
                    else pingClass = 'slow';
                } else if (config.ping) {
                    pingText = config.ping;
                    pingClass = 'slow';
                }
                card.style.borderColor = pingClass ? `var(--${pingClass})` : 'var(--secondary-color)';
                const useCaseText = getUseCase(config.ping);
                card.innerHTML = `<div class="card-header"><div class="card-location"><span class="fi fi-${config.country_code || 'xx'}"></span><span style="margin-right:10px;">${config.country || 'Unknown'}</span></div><div class="ping ${pingClass}">${pingText}</div></div><div class="card-details"><strong>${config.remarks}</strong><br><small>ISP: ${config.isp} | Port: ${config.port}</small></div><div class="use-case">${useCaseText}</div><div class="card-footer"><button class="qr-btn">QR</button><button class="copy-btn">Ú©Ù¾ÛŒ</button></div>`;
                card.querySelector('.copy-btn').onclick = e => { const btn = e.target; navigator.clipboard.writeText(config.config_str); btn.textContent = 'Ú©Ù¾ÛŒ Ø´Ø¯!'; setTimeout(() => { btn.textContent = 'Ú©Ù¾ÛŒ'; }, 2000); };
                card.querySelector('.qr-btn').onclick = () => { qrCodeContainer.innerHTML = ''; new QRCode(qrCodeContainer, { text: config.config_str, width: 256, height: 256 }); qrModal.style.display = 'flex'; };
                return card;
            } catch (error) {
                console.error("Failed to create card for config:", config, error);
                return null;
            }
        }

        function renderList(container, configs) {
            container.innerHTML = '';
            configs.forEach(config => {
                const card = createConfigCard(config);
                if (card) container.appendChild(card);
            });
        }
        
        scanBtn.addEventListener('click', async () => {
            if (!allConfigs.length) return;
            const btnText = scanBtn.querySelector('span');
            const spinner = scanBtn.querySelector('.spinner');
            scanBtn.disabled = true;
            btnText.textContent = 'Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª Û±Û° Ú©Ø§Ù†ÙÛŒÚ¯ ØªØµØ§Ø¯ÙÛŒ...';
            spinner.style.display = 'inline-block';
            
            const shuffled = [...allConfigs].sort(() => 0.5 - Math.random());
            const selection = shuffled.slice(0, 10);
            const testPromises = selection.map(config => getAverageLatency(config));
            const results = await Promise.all(testPromises);
            
            results.sort((a, b) => {
                const aPing = typeof a.ping === 'number' ? a.ping : Infinity;
                const bPing = typeof b.ping === 'number' ? b.ping : Infinity;
                return aPing - bPing;
            });

            renderList(resultsContainer, results);

            scanBtn.disabled = false;
            btnText.textContent = 'ğŸš€ ØªØ³Øª Ùˆ ÛŒØ§ÙØªÙ† Ø¨Ù‡ØªØ±ÛŒÙ† Ú©Ø§Ù†ÙÛŒÚ¯';
            spinner.style.display = 'none';
        });
        
        qrModal.addEventListener('click', e => (e.target === qrModal) && (qrModal.style.display = 'none'));

        async function init() {
            try {
                const response = await fetch('configs.json?v=' + Date.now());
                if (!response.ok) throw new Error('Network error');
                allConfigs = await response.json();
                if(!Array.isArray(allConfigs)) throw new Error("Data is not an array");
                
                statusEl.textContent = `Ù…Ø¬Ù…ÙˆØ¹ ${allConfigs.length} Ú©Ø§Ù†ÙÛŒÚ¯ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª.`;
                renderList(fullListContainer, allConfigs);

            } catch (error) {
                statusEl.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÛŒØ§ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§.';
                console.error("Initialization failed:", error);
            }
        }
        init();
    </script>
</body>
</html>
