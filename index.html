<script>
    const scanBtn = document.getElementById('scan-btn');
    const resultsContainer = document.getElementById('results-container');
    const statusEl = document.getElementById('status');
    let allConfigs = [];
    
    // --- Ø¢Ø¯Ø±Ø³ Ù¾Ø±ÙˆÚ©Ø³ÛŒ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¬Ø§ÛŒâ€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø´Ø¯ ---
    const PROXY_URL = "wss://rapid-scene-1da6.mbrgh87.workers.dev/"; 
    
    function getUseCase(ping) {
        if (ping < 250) return 'ğŸ® Ø¹Ø§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ: Ú¯ÛŒÙ… Ùˆ ÙˆØ¨â€ŒÚ¯Ø±Ø¯ÛŒ';
        if (ping < 500) return 'ğŸ¬ Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø±Ø§ÛŒ: Ø§Ø³ØªØ±ÛŒÙ… Ùˆ Ø´Ø¨Ú©Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ';
        return 'ğŸ“ Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø±Ø§ÛŒ: Ø¯Ø§Ù†Ù„ÙˆØ¯';
    }

    function pingOnce(config) {
        return new Promise(resolve => {
            const startTime = Date.now();
            const timeoutDuration = 3000;
            let ws;
            try {
                // Ø¢Ø¯Ø±Ø³ ÙˆØ±Ú©Ø± Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒÙ†Ú¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                ws = new WebSocket(PROXY_URL);
                ws.onopen = () => ws.send(JSON.stringify({ address: config.address, port: config.port }));
                ws.onmessage = (event) => { if (event.data === "success") succeed(); };
            } catch (e) { fail(); return; }
            const timeout = setTimeout(fail, timeoutDuration);
            function succeed() { clearTimeout(timeout); ws.close(); resolve(Date.now() - startTime); }
            function fail() { clearTimeout(timeout); if (ws) ws.close(); resolve(null); }
            ws.onerror = fail;
        });
    }

    function createConfigCard(config) {
        const card = document.createElement('div');
        card.className = 'card';
        const pingClass = config.ping < 400 ? 'fast' : (config.ping < 800 ? 'medium' : 'slow');
        card.style.borderColor = `var(--${pingClass})`;
        const useCaseText = getUseCase(config.ping);
        card.innerHTML = `<div class="card-header"><div class="card-location"><span class="fi fi-${config.country_code || 'xx'}"></span><span style="margin-right:10px;">${config.country || 'Unknown'}</span></div><div class="ping ${pingClass}">${config.ping}ms</div></div><div class="card-details"><strong>${config.remarks}</strong></div><div class="use-case">${useCaseText}</div><div class="card-footer"><button onclick="copyConfig('${config.config_str}')">Ú©Ù¾ÛŒ</button></div>`;
        return card;
    }
    
    function copyConfig(configStr) { navigator.clipboard.writeText(configStr); alert('Ú©Ù¾ÛŒ Ø´Ø¯!'); }

    function renderList(configs) {
        resultsContainer.innerHTML = '';
        if (configs.length === 0) { statusEl.textContent = 'Ù‡ÛŒÚ† Ú©Ø§Ù†ÙÛŒÚ¯ Ø¢Ù†Ù„Ø§ÛŒÙ†ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.'; return; }
        configs.forEach(config => resultsContainer.appendChild(createConfigCard(config)));
        statusEl.textContent = `Ù†Ù…Ø§ÛŒØ´ ${configs.length} Ú©Ø§Ù†ÙÛŒÚ¯ Ø¢Ù†Ù„Ø§ÛŒÙ†`;
    }
    
    async function runFullScan() {
        if (!allConfigs.length) { statusEl.textContent = 'Ù‡ÛŒÚ† Ú©Ø§Ù†ÙÛŒÚ¯ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ³Øª ÛŒØ§ÙØª Ù†Ø´Ø¯.'; return; }
        if (!PROXY_URL.includes("workers.dev")) { statusEl.textContent = 'Ø®Ø·Ø§: Ù„Ø·ÙØ§Ù‹ Ø¢Ø¯Ø±Ø³ Ù¾Ø±Ø§Ú©Ø³ÛŒ Ø´Ø®ØµÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± Ú©Ø¯ index.html ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.'; return; }

        const btnUI = scanBtn.querySelector('span');
        const spinner = scanBtn.querySelector('.spinner');
        scanBtn.disabled = true;
        btnUI.textContent = 'Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª...';
        spinner.style.display = 'inline-block';
        resultsContainer.innerHTML = '';

        const testPromises = allConfigs.map(config => pingOnce(config));
        const results = await Promise.all(testPromises);
        
        const onlineConfigs = allConfigs
            .map((config, i) => ({ ...config, ping: results[i] }))
            .filter(r => r.ping !== null)
            .sort((a, b) => a.ping - b.ping);

        renderList(onlineConfigs);

        scanBtn.disabled = false;
        btnUI.textContent = 'ğŸ”„ ØªØ³Øª Ù…Ø¬Ø¯Ø¯';
        spinner.style.display = 'none';
    }

    async function init() {
        try {
            const response = await fetch('configs.json?v=' + Date.now());
            if (!response.ok) throw new Error('Network error');
            allConfigs = await response.json();
            if(!Array.isArray(allConfigs)) throw new Error("Data is not an array");
            statusEl.textContent = `Ù…Ø¬Ù…ÙˆØ¹ ${allConfigs.length} Ú©Ø§Ù†ÙÛŒÚ¯ ÛŒØ§ÙØª Ø´Ø¯. Ø´Ø±ÙˆØ¹ ØªØ³Øª...`;
            runFullScan();
        } catch (error) {
            statusEl.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡. Ù„Ø·ÙØ§Ù‹ ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù†ÛŒØ¯.';
        }
    }
    scanBtn.addEventListener('click', runFullScan);
    init();
</script>
